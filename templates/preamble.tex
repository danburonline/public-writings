% ! ================
% ! # MARK: Packages
% ! ================

% ! Check if templatevariant is defined, default to essay if not
\providecommand{\templatevariant}{essay}

% Common packages used by both templates
\usepackage{makecell} % For thicker lines
\usepackage{setspace}  % Controls line spacing
\usepackage{hhline}   % For double horizontal lines
\usepackage{colortbl}  % Add colour to LaTeX tables
\usepackage[T1]{fontenc}  % Choice of font encodings
\usepackage{tgtermes}  % Loads the TeX Gyre Termes font
\usepackage{siunitx}  % A comprehensive (SI) units package
\usepackage{tabularx, booktabs} % For advanced table layout
\usepackage{url}  % Verbatim with URL-sensitive line breaks
\usepackage{authblk}  % For author and affiliation management
\usepackage{natbib}  % A package for bibliographies and citations
\usepackage{graphicx}  % Enhances LaTeX's built-in graphics features
\usepackage{listings}  % Typeset programming code within the document
\usepackage{amssymb}  % Mathematical symbols
\usepackage{amsmath}  % Advanced math environments including split
\usepackage[nottoc]{tocbibind}  % Adds entries to the table of contents
\usepackage{xcolor}  % Provides easy driver-independent access to colors
\usepackage{microtype}  % Improves the spacing between words and letters
\usepackage{enumitem}  % Control layout of itemize, enumerate, description
\usepackage{tocloft}  % Controls the typographic design of table of contents, etc.
\usepackage[breaklinks,linktocpage]{hyperref}  % Creates hyperlinks in your document
\usepackage[font=footnotesize,skip=7pt,labelfont=bf]{caption}  % Customising captions in floating envs
\usepackage{geometry}  % For page layout control

% Variant-specific packages and settings
\ifx\templatevariant\undefined
  \def\templatevariant{essay}
\fi

\def\papervariant{paper}
\def\essayvariant{essay}

\ifx\templatevariant\papervariant
  % Paper template specific packages
  \usepackage{multicol}  % For multi-column layout control
  \usepackage{dblfloatfix}  % Fix for double-column floats placement

  % Set default margins for paper template (larger margins for front/back matter)
  \geometry{
    left=3cm,
    right=3cm,
    top=2.5cm,
    bottom=3cm
  }

  % Multicolumn settings for paper template
  \setlength{\columnseprule}{0pt}  % Remove the line between columns
  \setlength{\columnsep}{0.7cm}  % Space between columns

  % Additional float settings for paper template
  \renewcommand{\dbltopfraction}{0.9}
  \renewcommand{\dblfloatpagefraction}{0.8}
\else
  % Essay template specific settings (default)
  % Set margins for single-column essay layout (extra comfortable reading margins)
  \geometry{
    left=4cm,
    right=4cm,
    top=3cm,
    bottom=3.5cm
  }
\fi

% Common float settings for better control
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.8}

% Adjust the page margins in the bibliography
\let\oldthebibliography=\thebibliography
\let\endoldthebibliography=\endthebibliography
\renewenvironment{thebibliography}[1]{%
  \begin{oldthebibliography}{#1}%
    \raggedright%
    \footnotesize%
    \setlength{\itemsep}{3pt}%
    \setlength{\parsep}{0pt}%
    \setlength{\parskip}{0pt}%
    }{%
  \end{oldthebibliography}%
}

\setlength\bibindent{0pt}

% ! Optional options
% \usepackage{background} % Creates a DRAFT background image on all pages
% \backgroundsetup{contents=DRAFT, opacity=0.25, color=gray} % Adds a watermark to the document
% % This command changes the line spacing to double.
% % ? Needed for reviews/drafts
% \doublespacing

% Custom colours
\definecolor{codegreen}{rgb}{0,0.5,0}
\definecolor{codegray}{rgb}{0.4,0.4,0.4}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.96,0.96,0.96}
\definecolor{lightgray}{gray}{0.8}

\lstdefinelanguage{JavaScript}{
  keywords={break, case, catch, continue, debugger, default, delete, do, else, finally, for, function, if, in, instanceof, new, return, switch, this, throw, try, typeof, var, void, while, with},
  morecomment=[l]{//},
  morecomment=[s]{/*}{*/},
  morestring=[b]',
  morestring=[b]",
  sensitive=true
}

% Listing styles
\lstdefinestyle{mystyle}{
  frame=tb,
  tabsize=2,
  captionpos=b,
  numbers=left,
  framerule=0pt,
  numbersep=5pt,
  showtabs=false,
  breaklines=true,
  keepspaces=true,
  showspaces=false,
  framextopmargin=6pt,
  framexbottommargin=6pt,
  showstringspaces=false,
  breakatwhitespace=false,
  keywordstyle=\color{purple},
  commentstyle=\color{codegreen},
  stringstyle=\color{codepurple},
  numberstyle=\tiny\color{codegray},
  basicstyle=\ttfamily\footnotesize,
  backgroundcolor=\color{backcolour}}
\lstset{style=mystyle}

% ! Custom template commands
% Add a vertical space after section numbers in ToC
\renewcommand\cftsecafterpnum{\vskip8pt}
% Changes the title of the list of listings
\renewcommand{\lstlistlistingname}{List of \lstlistingname s}
% Changes the title of the bibliography
\renewcommand{\bibname}{References}
% Changes the title of the table of contents
\renewcommand{\contentsname}{Table of Contents}
% Changes the leader between section and page numbers in ToC
\renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
\newcommand{\floatcaption}[2]{\caption[#1.]{#1~#2.}}

% Custom template settings
\captionsetup{justification=raggedright}  % All captions will be left-aligned
% Caption width now uses full text width for all figures

% Page numbering font size
\renewcommand{\thepage}{\footnotesize\arabic{page}}
\hypersetup{
  colorlinks = true,
  urlcolor = blue,
  linkcolor = blue,
  citecolor = blue,
  breaklinks = true
}
\PassOptionsToPackage{hyphens}{url}
\urlstyle{same}
\def\Urlmuskip{0mu plus 1mu}
\def\UrlBreaks{\do\/\do-}
\def\UrlBigBreaks{\do\/\do-\do:\do.}
\setlist[itemize]{noitemsep, topsep=0pt, partopsep=0pt}
